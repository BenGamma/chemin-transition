var app;app=angular.module("app",["ui.router","leaflet-directive","ipCookie","mm.foundation","ngAutocomplete","ngTagsInput","ngDropzone","autocomplete"]),app.run(["$rootScope","$location","$state","authService","ipCookie",function(e,t,r,n,o){return e.$on("$stateChangeStart",function(){return e.isLogged=!0,o("token")||o("email")?void 0:e.isLogged=!1})}]),app.config(["$stateProvider","$urlRouterProvider","$locationProvider",function(e,t){return t.otherwise(function(e){var t;return t=e.get("$state"),t.go("index.structures")}),e.state("index",{url:"/map",resolve:{organizations:["Organisations",function(e){return e.getOrganizations().then(function(e){return e})}]},views:{"":{templateUrl:"partials/home.html",controller:"HomeController"},navbar:{templateUrl:"partials/navbar.html",controller:"NavBarController"}},onEnter:["authService",function(e){return e.needsLogin?e.showLogin():void 0}]}).state("index.structures",{url:"/structures",views:{"":{templateUrl:"partials/structures/index.html",controller:"StructuresController"},filter:{templateUrl:"partials/ui/filter.html",controller:"StructuresController"}}}).state("index.news",{url:"/",templateUrl:"partials/structures/index.html"}).state("index.skills",{url:"/skills",templateUrl:"partials/structures/index.html"}).state("index.assets",{url:"/assets",templateUrl:"partials/structures/index.html"}).state("index.actors",{url:"/actors",templateUrl:"partials/structures/index.html"}).state("users",{url:"/users",resolve:{check:["$state","authService",function(e,t){return t.isAuthorize().then(function(e){return t.needsLogin=e})}]},views:{"":{template:"<div ui-view></div>"},navbar:{templateUrl:"partials/navbar.html",controller:"NavBarController"}}}).state("users.profile",{url:"/profile",controller:"UsersController",templateUrl:"partials/users/profile.html"}).state("structures",{url:"/structures",views:{"":{templateUrl:"partials/structures.html",controller:"StructuresController"},navbar:{templateUrl:"partials/navbar.html",controller:"NavBarController"}}}).state("structures.show",{url:"/:id",templateUrl:"partials/structures/show.html",resolve:{id:["$stateParams","Organisations",function(e){return e.id}]},controller:"StructuresShowController"}).state("skills",{url:"/skills",templateUrl:"partials/skills.html",controller:"SkillsController"}).state("assets",{url:"/assets",templateUrl:"partials/assets.html",controller:"AssetsController"})}]),app.factory("appConfig",function(){var e;return e="http://localhost:3000/api",{url:function(t){return""+e+"/"+t},domain:function(){return"http://localhost:3000"}}}),app.controller("AssetsController",["$scope","leafletData",function(){}]),app.service("authService",["ipCookie","userData","$state","$modal","$q",function(e,t,r,n,o){return{user:{},token:null,needsLogin:!1,setSession:function(t){return this.user=t,this.token=t.token,e("token",this.token,{expires:21}),e("email",this.user.email,{expires:21})},isAuthorize:function(){var n;return n=this,this.needsLogin=!0,e("token")||e("mail")?t.checkUser().then(function(){return this.needsLogin=!1},function(e){return 401===e?(n.destroySession(),r.go("index").then(function(){return r.reload()})):void 0}):r.go("index")},showLogin:function(){return this.login=n.open({templateUrl:"partials/login.html",controller:"LoginController",windowClass:"tiny"}),this.login.result.then(function(e){return $scope.selected=e})},hideLogin:function(){return this.login.dismiss("cancel")},showRegister:function(){return this.register=n.open({templateUrl:"partials/register.html",controller:"RegisterController",windowClass:"tiny"}),this.register.result.then(function(e){return $scope.selected=e})},hideRegister:function(){return this.register.dismiss("cancel")},destroySession:function(){return e.remove("token"),e.remove("email")},getGeocode:function(e){var t,r,n;return t=o.defer(),r=new google.maps.Geocoder,n=new google.maps.LatLng(parseFloat(e.coordinates[1]),parseFloat(e.coordinates[0])),r.geocode({latLng:n},function(e){return t.resolve(e)}),t.promise},setUserCoordinates:function(e,t){var r;return t.details&&(r=t.details.geometry.location,e.coordinates={lt:r.D,lg:r.k}),e}}}]),app.controller("FilterController",["$scope",function(){}]),app.controller("HomeController",["$scope","leafletData","authService","Organisations","$modal","appConfig",function(e,t,r,n,o,i){return e.open=function(){return r.showLogin()},e.organisations=n,e.mapView={active:!0,template:"partials/map.html"},e.listView={active:!1,template:"partials/list.html"},e.showMapView=function(){return e.mapView.active=!0,e.listView.active=!1},e.showListView=function(){return e.listView.active=!0,e.mapView.active=!1},e.showModal=function(t){return e.selected=t.target.feature.properties,this.modalInstance=o.open({templateUrl:"partials/modal.html",windowClass:"large",scope:e})},e.closeModal=function(){return this.modalInstance.dismiss("cancel")},$("#map").parents().height("100%"),L.mapbox.accessToken="pk.eyJ1IjoidG9ueWx1Y2FzIiwiYSI6IlRqa09UbE0ifQ.DGFIsGazdBZSk0t2PYe6Zw",angular.extend(e,{defaults:{tileLayer:"https://{s}.tiles.mapbox.com/v4/examples.map-i87786ca/{z}/{x}/{y}.png?access_token="+L.mapbox.accessToken,locate:!0,path:{weight:10,color:"#800000",opacity:1},center:{lat:48.8,lng:2.3,zoom:10}}}),n.getOrganizations().then(function(r){return e.organisations=r,console.log(e.organisations),t.getMap("map").then(function(t){var n,o,a,s,l;for(n=new L.MarkerClusterGroup({polygonOptions:{fillColor:"#3887be",color:"#3887be",weight:2,opacity:1,fillOpacity:.3}}),o=L.mapbox.featureLayer(),s=0,l=r.length;l>s;s++)a=r[s],a.avatar=i.domain()+a.image,a.properties["marker-color"]="#f86767";return o.setGeoJSON(r),o.eachLayer(function(t){var r;return r="<div class='text-center popup'><strong>"+t.feature.properties.name+"</strong><br><img src='"+t.feature.avatar+"'><br>",angular.forEach(t.feature.properties.skills,function(e){return console.log(e.name),r=r+"<span class='tag'>"+e.name+"</span>"}),r+="</div>",t.bindPopup(r),t.on("mouseover",function(){return t.openPopup()}),t.on("mouseout",function(){return t.closePopup()}),t.on("click",function(t){return e.showModal(t)}),n.addLayer(t)}),t.addLayer(n)})})}]),app.controller("LoginController",["$scope","$modalInstance","authService","userData","$state",function(e,t,r,n,o){return e.cancel=function(){return r.hideLogin()},e.login=function(e,t){return e.$invalid?void 0:n.login(t).then(function(e){return r.setSession(e),o.go("index").then(function(){return r.hideLogin(),o.reload()})},function(e){return t.error=e})}}]),app.controller("MapController",["$scope","leafletData","$modal","authService",function(e,t,r,n){return e.open=function(){return n.showLogin()}}]),app.directive("map",["leafletData","$timeout","Organisations","$modal","appConfig","mapService",function(){return{restrict:"E",controler:"HomeController",link:function(){return $("#map").parents().height("100%")}}}]),app.service("mapService",["leafletData",function(){return{init:function(){}}}]),app.controller("ModalController",["$scope","leafletData","$modal",function(e,t,r){return e.items=["item1","item2","item3"],e.open=function(){var t;return t=r.open({templateUrl:"myModalContent.html",scope:e,resolve:{items:function(){return e.items}}}),t.result.then(function(t){e.selected=t},function(){return $log.info("Modal dismissed at: "+new Date)})}}]),app.controller("NavBarController",["$scope","leafletData","$modal","authService","$state",function(e,t,r,n,o){return $(document).foundation(),e.openLogin=function(){return n.showLogin()},e.openRegister=function(){return n.showRegister()},e.logout=function(){return console.log("go"),n.destroySession(),o.go("index").then(function(){return o.reload()})}}]),app.factory("Organisations",["$http","$q","appConfig","ipCookie","authService",function(e,t,r,n,o){return{getOrganizations:function(){var n;return n=t.defer(),e({method:"GET",url:r.url("organizations")}).success(function(e){return n.resolve(e)}).error(function(e){return n.reject(e)}),n.promise},getOrganization:function(o){var i;return i=t.defer(),e({method:"GET",url:r.url("organizations/show/"+o),headers:{"X-token":n("token"),"X-email":n("email")}}).success(function(e){return i.resolve(e)}).error(function(e){return i.reject(e)}),i.promise},addActor:function(o,i){var a;return a=t.defer(),e({method:"POST",url:r.url("organizations/actor/"+i.id+"/"+o.id),headers:{"X-token":n("token"),"X-email":n("email")}}).success(function(e){return a.resolve(e)}).error(function(e){return a.reject(e)}),a.promise},removeActor:function(o,i){var a;return a=t.defer(),e({method:"DELETE",url:r.url("organizations/actor/"+i.id+"/"+o.id),headers:{"X-token":n("token"),"X-email":n("email")}}).success(function(e){return a.resolve(e)}).error(function(e){return a.reject(e)}),a.promise},update:function(i){var a;return a=t.defer(),e({method:"PUT",url:r.url("organizations/update/"+o.user.id),headers:{"X-token":n("token"),"X-email":n("email")},data:i}).success(function(e){return a.resolve(e)}).error(function(e){return a.reject(e)}),a.promise}}}]),app.controller("RegisterController",["$scope","$modalInstance","authService","userData",function(e,t,r,n){return e.type=!1,e.autocomplete={},e.cancel=function(){return r.hideRegister()},e.register=function(t,o){return r.setUserCoordinates(o,e.autocomplete),t.$invalid?void 0:n.create(o).then(function(){return r.hideRegister()},function(){return o.error="email Already use"})},e.typeChange=function(t){return e.type="Organization"===t.type?!1:!0}}]),app.controller("sideBarController",["$scope","leafletData","$modal","authService",function(e,t,r,n){return e.openLogin=function(){return n.showLogin()},e.openRegister=function(){return n.showRegister()}}]),app.factory("skillData",["$http","$q","appConfig","ipCookie",function(e,t,r){return{getSkills:function(){var n;return n=t.defer(),e({method:"GET",url:r.url("skills")}).success(function(e){return n.resolve(e)}).error(function(e){return n.reject(e)}),n.promise}}}]),app.controller("SkillsController",["$scope","leafletData",function(){}]),app.controller("StructuresController",["$scope","leafletData","$stateParams","Organisations","appConfig",function(){}]),app.controller("StructuresShowController",["$scope","leafletData","$stateParams","Organisations",function(e,t,r,n){return n.getOrganization(r.id).then(function(e){return console.log(e)})}]),app.factory("userData",["$http","$q","appConfig","ipCookie",function(e,t,r,n){return{login:function(n){var o;return o=t.defer(),e({method:"POST",url:r.url("sessions/login"),data:n}).success(function(e){return o.resolve(e)}).error(function(e){return o.reject(e)}),o.promise},getPersons:function(){var o;return o=t.defer(),e({method:"GET",url:r.url("users/persons"),headers:{"X-token":n("token"),"X-email":n("email")}}).success(function(e){return o.resolve(e)}).error(function(e){return o.reject(e)}),o.promise},getOrganizationProfile:function(){var o;return o=t.defer(),e({method:"GET",url:r.url("organizations/profile"),headers:{"X-token":n("token"),"X-email":n("email")}}).success(function(e){return o.resolve(e)}).error(function(e){return o.reject(e)}),o.promise},getCurrentUser:function(){var o;return o=t.defer(),e({method:"GET",url:r.url("sessions"),headers:{"X-token":n("token"),"X-email":n("email")}}).success(function(e){return o.resolve(e)}).error(function(e){return o.reject(e)}),o.promise},checkUser:function(){var o;return o=t.defer(),e({method:"GET",url:r.url("sessions"),headers:{"X-token":n("token"),"X-email":n("email")}}).success(function(e,t){return o.resolve(t)}).error(function(e,t){return o.reject(t)}),o.promise},create:function(n){var o;return o=t.defer(),e({method:"POST",url:r.url("users"),data:n}).success(function(e,t){return o.resolve(t)}).error(function(e,t){return o.reject(t)}),o.promise},update:function(o){var i;return i=t.defer(),e({method:"PUT",url:r.url("users"),params:{id:o._id},data:o,headers:{token:n("token"),email:n("email")}}).success(function(e,t){return i.resolve(t)}).error(function(e,t){return i.reject(t)}),i.promise},"delete":function(){var n;return n=t.defer(),e({method:"DELETE",url:r.url("users"),params:{id:user._id},data:user}).success(function(e,t){return n.resolve(t)}).error(function(e,t){return n.reject(t)}),n.promise}}}]),app.controller("UsersController",["$scope","authService","userData","skillData","Organisations","appConfig","$timeout",function(e,t,r,n,o,i,a){return e.autocomplete={},e.alerts=[],e.closeAlert=function(t){return e.alerts.splice(t,1)},r.getCurrentUser().then(function(n){return e.user=n,t.user=n,e.setUpload(),angular.isDefined(n.image)&&(e.avatar=i.domain()+n.image),"Organization"===n.type?r.getOrganizationProfile().then(function(r){return t.getGeocode(r).then(function(t){return e.autocomplete.coordinates=t[0].formatted_address}),e.user=r}):void 0}),n.getSkills().then(function(t){return e.skills=t}),r.getPersons().then(function(t){return e.persons=t}),e.update=function(r,n){return r.$invalid?e.alerts.push({type:"alert-box warning radius",msg:"Invalid informations."}):(e.alerts.push({type:"alert-box success radius",msg:"Profile updated !"}),n=t.setUserCoordinates(n,e.autocomplete),o.update(n).then(function(){})),a(function(){return e.closeAlert()},4e3)},e.addActor=function(e){return o.addActor(e,t.user).then(function(){})},e.removeActor=function(e){return o.removeActor(e,t.user).then(function(){})},e.setUpload=function(){return e.dropzoneConfig={url:i.url("users/upload/image/"+t.user.id),maxFiles:1,dictDefaultMessage:"Drag your avatar profile here",init:function(){var e;return e={name:"test"},e={name:"avatar",size:12345},this.on("maxfilesexceeded",function(e){return this.removeAllFiles(),this.addFile(e)})}},e.eventHandlers={success:function(t,r){return e.avatar=r}}}}]);